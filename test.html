<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silence Remover API Test</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 600px;
            margin: 40px auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        h1 { color: #fff; margin-bottom: 8px; }
        .subtitle { color: #888; margin-bottom: 24px; }
        input, button, select {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #333;
            border-radius: 6px;
            font-size: 14px;
            background: #16213e;
            color: #eee;
        }
        input:focus, select:focus { outline: none; border-color: #0f4c75; }
        button {
            background: #0f4c75;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        button:hover { background: #1a6aa5; }
        button:disabled { background: #444; cursor: not-allowed; }
        .status {
            margin-top: 20px;
            padding: 16px;
            border-radius: 6px;
            background: #16213e;
            display: none;
        }
        .status.show { display: block; }
        .status-header { display: flex; justify-content: space-between; align-items: center; }
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-badge.pending { background: #f39c12; color: #000; }
        .status-badge.processing { background: #3498db; color: #fff; }
        .status-badge.completed { background: #27ae60; color: #fff; }
        .status-badge.error { background: #e74c3c; color: #fff; }
        .progress { margin-top: 12px; color: #aaa; }
        .result { margin-top: 12px; }
        .result a {
            display: inline-block;
            margin-top: 8px;
            padding: 10px 20px;
            background: #27ae60;
            color: white;
            text-decoration: none;
            border-radius: 6px;
        }
        .result a:hover { background: #2ecc71; }
        .error-msg { color: #e74c3c; margin-top: 8px; }
        .log {
            margin-top: 20px;
            padding: 12px;
            background: #0d0d1a;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .log-entry { margin: 4px 0; color: #888; }
        .log-entry.info { color: #3498db; }
        .log-entry.success { color: #27ae60; }
        .log-entry.error { color: #e74c3c; }
        .endpoint-select { margin-bottom: 16px; }
        label { display: block; margin-top: 12px; color: #aaa; font-size: 13px; }
    </style>
</head>
<body>
    <h1>Silence Remover API</h1>
    <p class="subtitle">Test the video processing endpoints</p>

    <label>API Key</label>
    <input type="password" id="apiKey" placeholder="Enter your API key">

    <div class="endpoint-select">
        <label>Endpoint</label>
        <select id="endpoint">
            <option value="remove-silence">Remove Silence</option>
            <option value="burn-captions">Burn Captions</option>
        </select>
    </div>

    <label>Video URL (public)</label>
    <input type="url" id="videoUrl" placeholder="https://example.com/video.mp4">

    <div id="captionOptions" style="display: none;">
        <label>Words JSON (for burn-captions)</label>
        <textarea id="wordsJson" style="width:100%; height:80px; padding:12px; background:#16213e; color:#eee; border:1px solid #333; border-radius:6px; font-family:monospace; font-size:12px;" placeholder='[{"word":"Hello","start":0.0,"end":0.5},{"word":"world","start":0.6,"end":1.0}]'></textarea>
    </div>

    <button id="submitBtn" onclick="submitJob()">Process Video</button>

    <div id="status" class="status">
        <div class="status-header">
            <span>Job: <code id="jobId">-</code></span>
            <span id="statusBadge" class="status-badge pending">pending</span>
        </div>
        <div id="progressText" class="progress"></div>
        <div id="resultArea" class="result"></div>
    </div>

    <div id="log" class="log"></div>

    <script>
        const API_BASE = 'https://silenceremover-14a00b007e5f.herokuapp.com';
        let pollInterval = null;

        document.getElementById('endpoint').addEventListener('change', (e) => {
            document.getElementById('captionOptions').style.display =
                e.target.value === 'burn-captions' ? 'block' : 'none';
        });

        function log(msg, type = '') {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `<div class="log-entry ${type}">[${time}] ${msg}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        async function submitJob() {
            const endpoint = document.getElementById('endpoint').value;
            const videoUrl = document.getElementById('videoUrl').value.trim();

            if (!videoUrl) {
                alert('Please enter a video URL');
                return;
            }

            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.textContent = 'Submitting...';

            document.getElementById('status').classList.add('show');
            document.getElementById('statusBadge').className = 'status-badge pending';
            document.getElementById('statusBadge').textContent = 'pending';
            document.getElementById('progressText').textContent = '';
            document.getElementById('resultArea').innerHTML = '';

            log(`Submitting to /${endpoint}...`, 'info');

            try {
                let body = { video_url: videoUrl };

                if (endpoint === 'burn-captions') {
                    const wordsJson = document.getElementById('wordsJson').value.trim();
                    if (!wordsJson) {
                        alert('Please enter words JSON for burn-captions');
                        btn.disabled = false;
                        btn.textContent = 'Process Video';
                        return;
                    }
                    body.words = JSON.parse(wordsJson);
                    body.words_per_line = 3;
                    body.style_preset = 'tiktok';
                }

                const apiKey = document.getElementById('apiKey').value.trim();
                const headers = { 'Content-Type': 'application/json' };
                if (apiKey) headers['X-API-Key'] = apiKey;

                const res = await fetch(`${API_BASE}/${endpoint}`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(body)
                });

                const data = await res.json();

                if (data.job_id) {
                    document.getElementById('jobId').textContent = data.job_id;
                    log(`Job created: ${data.job_id}`, 'success');
                    pollStatus(endpoint, data.job_id);
                } else {
                    log(`Error: ${data.error || 'Unknown error'}`, 'error');
                    document.getElementById('statusBadge').className = 'status-badge error';
                    document.getElementById('statusBadge').textContent = 'error';
                }
            } catch (err) {
                log(`Error: ${err.message}`, 'error');
                document.getElementById('statusBadge').className = 'status-badge error';
                document.getElementById('statusBadge').textContent = 'error';
            }

            btn.disabled = false;
            btn.textContent = 'Process Video';
        }

        function pollStatus(endpoint, jobId) {
            if (pollInterval) clearInterval(pollInterval);

            pollInterval = setInterval(async () => {
                try {
                    const apiKey = document.getElementById('apiKey').value.trim();
                    const headers = {};
                    if (apiKey) headers['X-API-Key'] = apiKey;

                    const res = await fetch(`${API_BASE}/${endpoint}/status/${jobId}`, { headers });
                    const data = await res.json();

                    const badge = document.getElementById('statusBadge');
                    badge.textContent = data.status;
                    badge.className = `status-badge ${data.status}`;

                    document.getElementById('progressText').textContent = data.progress || '';

                    if (data.status === 'completed') {
                        clearInterval(pollInterval);
                        log(`Completed! Time saved: ${data.time_saved_seconds?.toFixed(1) || 0}s`, 'success');

                        const apiKeyParam = apiKey ? `?api_key=${encodeURIComponent(apiKey)}` : '';
                        const downloadUrl = `${API_BASE}/${endpoint}/download/${jobId}${apiKeyParam}`;
                        document.getElementById('resultArea').innerHTML = `
                            <div>Silence removed: ${data.silence_removed || 'N/A'} periods</div>
                            <div>Time saved: ${data.time_saved_seconds?.toFixed(1) || 0}s</div>
                            <div>Output size: ${data.output_size_mb?.toFixed(2) || 0} MB</div>
                            <a href="${downloadUrl}" target="_blank">Download Video</a>
                        `;
                    } else if (data.status === 'error') {
                        clearInterval(pollInterval);
                        log(`Error: ${data.error}`, 'error');
                        document.getElementById('resultArea').innerHTML = `<div class="error-msg">${data.error}</div>`;
                    } else {
                        log(`Status: ${data.status} - ${data.progress || ''}`, 'info');
                    }
                } catch (err) {
                    log(`Poll error: ${err.message}`, 'error');
                }
            }, 2000);
        }
    </script>
</body>
</html>
